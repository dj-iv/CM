# Proposal persistence & portal plan

## Firestore setup

- **Collection**: `proposals`
  - `slug` *(string, document id)* – human readable identifier derived from the quote number or autogenerated.
  - `encodedState` *(string)* – base64 gzip of the cost model state so the calculator can restore and resave a proposal.
  - `proposal` *(map)* – flattened object used by the proposal viewer (`ProposalClient`) to render the document.
  - `metadata` *(map)* – denormalised fields used for filtering/listing:
    - `customerName` *(string)*
    - `customerNameLower` *(string)*
    - `solutionType` *(string)*
    - `numberOfNetworks` *(number)*
    - `quoteNumber` *(string | null)*
    - `totalPrice` *(number)*
    - `supportTier` *(string | null)*
  - `pdf` *(map)* – optional PDF status snapshot returned by the pdfshift workflow.
    - `status` *("idle" | "processing" | "ready" | "error")*
    - `url` *(string | null)* – presigned download URL (when stored in storage) or `null` when streaming directly.
    - `lastGeneratedAt` *(timestamp | null)*
    - `error` *(string | null)*
  - `createdAt` *(timestamp)* – Firestore server timestamp.
  - `updatedAt` *(timestamp)* – Firestore server timestamp.
  - `createdBy` *(map)* – Firebase user snapshot `{ uid, email, displayName }`.

Indexes to create once deployed:

- Composite `metadata.customerNameLower ASC, updatedAt DESC` for case-insensitive alphabetical filtering.
- (Optional) `metadata.quoteNumber` equality queries for direct lookups.

## Authentication & security

- The cost model already requires Google Sign-In restricted to the `uctel.co.uk` domain.
- Every API call from the calculator will include a Firebase ID token (`Authorization: Bearer <token>`).
- Next.js (Blaze plan) will run `firebase-admin` to verify the token and perform writes on behalf of the user.
- Firestore security rules can remain strict (no anonymous writes) because only the admin SDK touches the database.

## Environment configuration

Add the following environment variables to the Next.js app (`prop/.env.local`):

- `FIREBASE_PROJECT_ID`
- `FIREBASE_CLIENT_EMAIL`
- `FIREBASE_PRIVATE_KEY` *(replace literal `\n` with real newlines when loading)*
- `PORTAL_COST_MODEL_BASE_URL` – public URL of the calculator (used to build "Edit in Cost Model" links).
- `PDFSHIFT_API_KEY` – reused for server-side PDF conversion.

When deploying to Vercel or another host, configure the same values in the environment settings.

## API surface (Next.js)

| Route | Method | Purpose |
| --- | --- | --- |
| `/api/proposals` | `POST` | Create or update a proposal document. Generates slug when omitted. Requires ID token. |
| `/api/proposals` | `GET` | Paginated list of proposals for the portal (default 50, optional search query). Requires ID token. |
| `/api/proposals/[slug]` | `GET` | Fetch a single proposal (proposal data + metadata + encoded state). |
| `/api/proposals/[slug]` | `PUT` | Update a proposal payload/state. |
| `/api/proposals/[slug]/pdf` | `POST` | Trigger PDFShift conversion using stored HTML. Returns a streaming PDF response. |

The existing `/api/convert-to-pdf` helper from the legacy stack will be ported to Back-end utilities and used by the new PDF route.

## Portal experience

- Landing page lists proposals ordered by `updatedAt DESC` with quick filters (search by customer or quote).
- Each row exposes actions:
  - **Open viewer** – `/${slug}`.
  - **Edit in cost model** – `${PORTAL_COST_MODEL_BASE_URL}#${encodedState}`.
  - **Download PDF** – calls `/api/proposals/[slug]/pdf`.
- Future enhancements: tag proposals, set statuses, archive.

## Cost Model integration

- New "Save to Portal" button gathers `encodedState` + computed `proposal` and calls `/api/proposals`.
- Slugs default to the sanitized quote number; fallback uses customer name + timestamp.
- Successful saves cache the returned slug locally so subsequent saves automatically update the same record.
- Loading an existing proposal (from portal link) continues to use the hash-based state restore which already works today.

This plan keeps the calculator workflow familiar while giving teams a persistent store and admin-friendly portal backed by Firestore Blaze.
